# ボードゲーム 実装要件定義とシステム設計（Zombie Poker）

ユーザーから提供された「ルール.txt」に基づき、VRChat向けボードゲームの要件定義と、プロジェクト憲章（AGENTS.md）に従った「委譲（Composition）」を用いたUdonSharpの設計計画を記述します。

## 1. ゲームルールの仕様解釈（要件定義）
*   **プレイヤー人数**: 3〜5人。ワールド内には5つの「席（Seat）」オブジェクトを用意し、座ったプレイヤーが参加者となる。
*   **使用カード（計36枚）**:
    *   **心、技、体**（各11枚：Lv2×5, Lv3×3, Lv4×2, Lv5×1）
    *   **幼い少女**（特殊：3枚）
*   **ゲーム進行**:
    *   初期手札: 5枚（3人プレイ時は6枚）。残りは山札。
    *   **「攻撃」と「防御」のステップ**:
        1.  **攻撃側**: 同属性・同数字のカードを任意の枚数出す。
        2.  **防御側（次の人）**: 攻撃と同じ属性のカードを出す。出せない/出したくない場合は「パス」し、山札から1枚引く。
    *   **勝敗判定**:
        *   攻撃成功（攻撃≧防御）: 防御側は出したカードをトラッシュ（捨て札）にし、その枚数分山札から引く。防御側が次の攻撃プレイヤーとなる。
        *   防御成功（防御＞攻撃）: 防御側が出したカードをすべて攻撃側の手札に押し付ける（※幼い少女含みの特殊処理あり）。防御側が次の攻撃プレイヤーとなる。
    *   全員がパスした場合: 場札を流し、再び最後の攻撃プレイヤーからカードを出す。
*   **山札切れ（Deck Out）時の制限**: 手札補充なし。勝てる手札がない場合は自動パスとなり、パス時のドローも発生しない。
*   **勝利条件**: 手札が0枚になったプレイヤーから勝ち抜け。最後の一人（敗者）が決まるまで続く。

## 2. VRChat上でのプレイフィール（UIと操作仕様）
VRChatのVR環境でストレスなく遊べるよう、物理的なカード（オブジェクト）を持たせず、**「席に着いた各プレイヤー専用のUIパネル」で操作を完結させる**設計とします。

*   **カードの表現**:
    *   36枚のJPG/PNG画像をUnityのSpriteとして登録し、UI（`Image` コンポーネント）上で表示します。
*   **プレイヤーの操作画面（手札UI）**:
    *   各席の目前に、自分専用のキャンバスが浮かびます。そこに自分の手札の画像が並びます。
    *   手札の画像をクリック（Interact）すると、カードが「選択状態（少し上にスライド等）」になります。複数選択も可能です。
    *   画面上の**「場に出す」ボタン**を押すと、選択した手札が中央のメインボード（全員が見える場）に移動し、ターンが進行します。
    *   **「パス」ボタン**を押すとパス扱いになります。
*   **「幼い少女」の引き取り処理（ダイアログUI）**:
    *   ご懸念の処理は、専用UIを利用することでスムーズに解決します。防御側が「幼い少女」を含めて勝利した場合、攻撃側の手札UIの上に「受け取るカードを選択してください」というポップアップダイアログ（場に出されたカードの一覧）が表示されます。攻撃側がそこから選んで「決定」を押すことでゲームが再開されます。

## 3. UdonSharp クラス設計案（委譲ベース）
AGENTS.mdの「LSPの制限：継承よりも委譲」および「SRP（単一責任）と同期の兼ね合い」の原則に従い、以下のようにコンポーネントを分割・構成します。

### 📌 データの同期・全体管理（Manager層）
ネットワーク同期用の変数はここに集約し、処理自体は他のコンポーネントに委譲します。

*   **`GameManager`**:
    *   役割: 現在のフェーズ（待機、手札配布、攻撃、防御、決着）、現在ターン（攻撃者ID、防御者ID）、勝抜者のリストなどの全体状態を `[UdonSynced]` で管理する。
*   **`DeckManager`**:
    *   役割: 全36枚のカードの現在の場所（山札、誰の手札、場札、捨て札）を管理する `[UdonSynced]` の配列を持つ。
    *   実装ポイント: Udonの制限上、クラスをListにするのではなく「要素数36の `int[] cardLocations`（各値が所有者IDまたは場所IDを示す）」として管理するのが最も軽く安全です。

### 📌 ロジック処理（Controller層 - GameManagerにアタッチし委譲）
*   **`TurnController`**:
    *   役割: 「誰がどのカードを出したか」を受け取り、攻撃と防御の数値を比較して、その結果（どちらが勝ってどこへカードが動くか）を判定する。
*   **`CardDatabase`** (非同期・静的データ):
    *   役割: カードID（0〜35）を渡すと、そのカードの属性（心/技/体/特殊）と数値（2〜5, 少女は特殊）を返す計算用スクリプト。

### 📌 プレイヤーごとの操作・表示（Seat / UI層）
*   **`PlayerSeat`**:
    *   役割: ワールド上に5つ配置。プレイヤーが座る（InteractまたはTrigger）ことで参加登録を行う。自分の手札配列をDeckManagerから読み取り、目の前にカードオブジェクトを並べる。
*   **`HandController`** (ローカル専用):
    *   役割: ローカルプレイヤーが手札をクリックして選び、「場に出す」「パスする」ボタンを押したときにイベントを発火させる。

## 3. 実装の進め方・マイルストーン
1.  **フェーズ1: 盤面とデータの初期化（Deck & Seat）**
    *   36枚のカードデータ定義と、シャッフル＆配布ロジック（`DeckManager`）の実装。
    *   プレイヤーが席に座り、自分の手札だけが見える状態を作る。
2.  **フェーズ2: ターンの進行とカード提出（Game Flow）**
    *   攻撃者がカードを出し、次の人が防御者として指定されるサイクルの構築。
    *   UIでの「属性縛り」の判定（出せないカードをグレーアウト等）。
3.  **フェーズ3: バトル判定とカード移動（Battle Resolution）**
    *   出されたカードを加算比較し、勝敗に応じて手札や捨て札へカードを移動する。
    *   幼い少女の特殊処理（合計値加算や手札引き取り選択）の実装。
4.  **フェーズ4: 終了条件と例外処理**
    *   手札0枚での勝ち抜け、山札切れ時の特殊ルール（ドローなし・自動パス判定）の実装。

---
> [!IMPORTANT]
> **ユーザー様への確認事項:**
> 1. 上記のルールの解釈と、UdonSharp（ネットワーク等）を見据えたシステム構成にご納得いただけますでしょうか？
> 2. 例えば「防御側が幼い少女を含んで勝利した場合、攻撃者が引き取るカードを選ぶ」という処理は、VRChat上では「攻撃者の画面にUIを出して選ばせる」というワンクッションの同期待機処理が必要になります。このままの実装で進めて問題ありませんか？
